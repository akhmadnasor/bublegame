<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Math Bubbles - Belajar Perkalian SD</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Fredoka+One&family=Varela+Round&display=swap');

        body {
            margin: 0;
            padding: 0;
            background-color: #cce0ff;
            font-family: 'Varela Round', sans-serif;
            overflow: hidden;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            user-select: none;
        }

        /* Container Utama */
        #game-container {
            position: relative;
            width: 800px;
            height: 600px;
            background: linear-gradient(to bottom, #b3c6ff, #d9e6ff);
            border-radius: 20px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.2);
            overflow: hidden;
        }

        /* UI Overlay (Menu, Settings, HUD) */
        .screen {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 10;
        }

        .hidden { display: none !important; }

        /* Judul */
        h1.title {
            font-family: 'Fredoka One', cursive;
            font-size: 80px;
            color: #5c8aff;
            text-shadow: 4px 4px 0px #ffffff, 7px 7px 0px rgba(0,0,0,0.1);
            margin-bottom: 20px;
            letter-spacing: 2px;
        }

        /* Tombol Keren */
        .btn {
            background: linear-gradient(to bottom, #00c6ff, #0072ff);
            border: 3px solid #fff;
            color: white;
            padding: 15px 60px;
            font-size: 28px;
            font-family: 'Fredoka One', cursive;
            border-radius: 50px;
            cursor: pointer;
            box-shadow: 0 6px 0 #004a9e, 0 10px 10px rgba(0,0,0,0.2);
            transition: transform 0.1s;
            margin: 10px;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.3);
            text-decoration: none;
            display: inline-block;
        }

        .btn:active {
            transform: translateY(6px);
            box-shadow: 0 0 0 #004a9e, 0 0 0 rgba(0,0,0,0.2);
        }

        .btn-small {
            padding: 10px 30px;
            font-size: 20px;
            background: linear-gradient(to bottom, #ff9966, #ff5e62);
            box-shadow: 0 6px 0 #b92b27, 0 10px 10px rgba(0,0,0,0.2);
        }
        .btn-small:active { box-shadow: 0 0 0 #b92b27; }

        /* Tombol Settings (Gear) */
        .gear-btn {
            position: absolute;
            bottom: 20px;
            left: 20px;
            width: 60px;
            height: 60px;
            background: linear-gradient(to bottom, #00c6ff, #0072ff);
            border-radius: 50%;
            border: 3px solid white;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            box-shadow: 0 5px 0 #004a9e;
        }
        .gear-icon { font-size: 30px; color: white; }

        /* HUD (Skor, Stage di kiri) */
        #hud {
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            width: 160px;
            background: rgba(255, 255, 255, 0.4);
            border-right: 2px solid white;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding-top: 20px;
            z-index: 5;
        }

        .hud-box {
            background: rgba(255,255,255,0.6);
            border-radius: 15px;
            padding: 10px;
            width: 120px;
            text-align: center;
            margin-bottom: 20px;
            box-shadow: inset 0 2px 5px rgba(0,0,0,0.05);
        }

        .hud-label { font-size: 14px; color: #666; font-weight: bold; text-transform: uppercase; }
        .hud-value { font-size: 32px; color: #444; font-family: 'Fredoka One', cursive; }

        /* Canvas Game */
        canvas {
            display: block;
            margin-left: 160px; /* Offset karena ada HUD di kiri */
        }

        /* Modal Settings */
        .modal-content {
            background: rgba(255, 255, 255, 0.9);
            padding: 40px;
            border-radius: 30px;
            text-align: center;
            box-shadow: 0 0 20px rgba(0,0,0,0.2);
            border: 5px solid #fff;
            width: 400px;
        }
        .setting-row {
            margin: 15px 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: #eef;
            padding: 10px 20px;
            border-radius: 50px;
            font-weight: bold;
            color: #555;
            border: 2px solid #fff;
            box-shadow: 0 4px 0 #ddd;
        }
        
        .flag-icon { font-size: 24px; margin-right: 10px; }

    </style>
</head>
<body>

    <div id="game-container">
        
        <div id="menu-screen" class="screen">
            <h1 class="title">BUBBLES<br><span style="font-size:40px; color:#ff6b6b">Matematika</span></h1>
            <button class="btn" onclick="startGame()">MAIN</button>
            
            <div class="gear-btn" onclick="showSettings()">
                <div class="gear-icon">‚öôÔ∏è</div>
            </div>
        </div>

        <div id="settings-screen" class="screen hidden">
            <div class="modal-content">
                <h2 style="color:#5c8aff; margin-top:0;">Pengaturan</h2>
                
                <div class="setting-row">
                    <span>Cara Main</span>
                    <button class="btn-small" style="font-size:14px; padding:5px 15px;">?</button>
                </div>
                
                <div class="setting-row">
                    <span>Suara</span>
                    <span>ON üîä</span>
                </div>

                <div class="setting-row">
                    <span>Bahasa</span>
                    <span>üáÆüá© Indonesia</span>
                </div>

                <div style="margin-top: 30px;">
                    <button class="btn-small" onclick="closeSettings()">Kembali</button>
                </div>
            </div>
        </div>

        <div id="game-ui" class="hidden">
            <div id="hud">
                <div class="hud-box">
                    <div class="hud-label">Stage</div>
                    <div class="hud-value" id="stage-val">1</div>
                </div>
                <div class="hud-box">
                    <div class="hud-label">Skor</div>
                    <div class="hud-value" id="score-val">0</div>
                </div>
                <div class="hud-box">
                    <div class="hud-label">Target</div>
                    <div class="hud-value" id="target-val">5</div>
                </div>
                
                <div style="margin-top:auto; margin-bottom: 20px;">
                    <button class="btn-small" style="font-size:24px; padding: 10px; border-radius:50%; width:50px; height:50px;" onclick="togglePause()">‚è∏</button>
                </div>
            </div>
            <canvas id="gameCanvas" width="640" height="600"></canvas>
        </div>

        <div id="end-screen" class="screen hidden">
            <h1 class="title" id="end-title">SELESAI!</h1>
            <p style="font-size: 24px; color: #444; font-weight:bold;">Skor Akhir: <span id="final-score">0</span></p>
            <button class="btn" onclick="location.reload()">MAIN LAGI</button>
        </div>

    </div>

<script>
    /** KONFIGURASI GAME **/
    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d');
    
    // Warna-warni bola (Pastel cerah)
    const COLORS = ['#FF6B6B', '#4ECDC4', '#FFE66D', '#1A535C', '#FF9F1C', '#D90368'];
    
    // State Game
    let gameState = 'MENU'; // MENU, PLAY, PAUSE, OVER
    let score = 0;
    let stage = 1;
    let correctCount = 0; // Target 5 per stage
    let bubbles = []; // Grid bola di atas
    let particles = []; // Efek ledakan
    let bullet = null; // Bola yang ditembak
    let currentBall = null; // Bola yang siap ditembak (berisi jawaban)
    let nextBall = null; // Bola antrian berikutnya
    let mouseX = 0;
    let mouseY = 0;
    
    const BUBBLE_RADIUS = 28;
    const ROWS = 5;
    const COLS = 10;
    const OFFSET_X = 40;
    const OFFSET_Y = 40;

    // --- LOGIKA MATEMATIKA ---
    
    // Generate soal perkalian berdasarkan stage
    function generateProblem(stageLevel) {
        let maxNum = 5; // Stage 1: 1-5
        if (stageLevel === 2) maxNum = 8; // Stage 2: 1-8
        if (stageLevel === 3) maxNum = 10; // Stage 3: 1-10

        let a = Math.floor(Math.random() * maxNum) + 1;
        let b = Math.floor(Math.random() * 10) + 1;
        return {
            q: `${a} x ${b}`,
            a: a * b,
            color: COLORS[Math.floor(Math.random() * COLORS.length)]
        };
    }

    class Bubble {
        constructor(x, y, problem) {
            this.x = x;
            this.y = y;
            this.r = BUBBLE_RADIUS;
            this.problem = problem; // Object {q: "3x3", a: 9, color: "..."}
            this.isQuestion = true; // True = nampilin soal di Grid, False = nampilin jawaban di shooter
            this.active = true;
        }

        draw(context) {
            if (!this.active) return;
            
            // Gambar Lingkaran 3D simple
            context.beginPath();
            context.arc(this.x, this.y, this.r, 0, Math.PI * 2);
            let grad = context.createRadialGradient(this.x - 10, this.y - 10, 5, this.x, this.y, this.r);
            grad.addColorStop(0, '#fff');
            grad.addColorStop(0.3, this.problem.color);
            grad.addColorStop(1, shadeColor(this.problem.color, -40));
            context.fillStyle = grad;
            context.fill();
            context.strokeStyle = 'white';
            context.lineWidth = 2;
            context.stroke();
            context.closePath();

            // Teks (Soal atau Jawaban)
            context.fillStyle = '#fff';
            context.font = "bold 16px 'Varela Round'";
            context.textAlign = "center";
            context.textBaseline = "middle";
            context.shadowColor = "rgba(0,0,0,0.5)";
            context.shadowBlur = 4;
            
            let text = this.isQuestion ? this.problem.q : this.problem.a;
            context.fillText(text, this.x, this.y);
            context.shadowBlur = 0; // Reset shadow
        }
    }

    // --- FUNGSI UTAMA ---

    function initGame() {
        score = 0;
        stage = 1;
        resetStage();
        updateHUD();
        loop();
    }

    function resetStage() {
        correctCount = 0;
        bubbles = [];
        particles = [];
        bullet = null;
        
        // Buat Grid Awal (3 baris)
        for (let r = 0; r < 3; r++) {
            for (let c = 0; c < COLS; c++) {
                // Posisi zig-zag sedikit
                let x = c * (BUBBLE_RADIUS * 2) + OFFSET_X + (r % 2 == 1 ? BUBBLE_RADIUS : 0);
                let y = r * (BUBBLE_RADIUS * 2) + OFFSET_Y;
                
                // Jangan terlalu penuh di awal
                if(Math.random() > 0.1) {
                    bubbles.push(new Bubble(x, y, generateProblem(stage)));
                }
            }
        }
        
        prepareShooter();
    }

    function prepareShooter() {
        // Ambil salah satu jawaban dari grid yang ada agar pasti bisa dijawab
        let availableAnswers = bubbles.filter(b => b.active).map(b => b.problem);
        
        if (availableAnswers.length === 0) {
            // Jika grid habis (menang premature), isi ulang
             stageClear();
             return;
        }

        // Logic queue bola
        let p1 = availableAnswers[Math.floor(Math.random() * availableAnswers.length)];
        let p2 = availableAnswers[Math.floor(Math.random() * availableAnswers.length)]; // Untuk next ball

        if (!currentBall) {
            currentBall = new Bubble(canvas.width / 2, canvas.height - 50, p1);
            currentBall.isQuestion = false;
        }
        
        // Next ball visual (kecil di samping)
        nextBall = new Bubble(canvas.width / 2 - 80, canvas.height - 30, p2); 
    }

    // Load next ball
    function reloadShooter() {
        if(!nextBall) return;
        currentBall = new Bubble(canvas.width / 2, canvas.height - 50, nextBall.problem);
        currentBall.isQuestion = false;
        
        // Generate new random 'next' based on remaining board
        let availableAnswers = bubbles.filter(b => b.active).map(b => b.problem);
        if(availableAnswers.length > 0) {
            let p = availableAnswers[Math.floor(Math.random() * availableAnswers.length)];
            nextBall = new Bubble(canvas.width / 2 - 80, canvas.height - 30, p);
        } else {
            nextBall = null;
        }
    }

    function shoot() {
        if (bullet || !currentBall) return;

        // Hitung sudut
        let dx = mouseX - currentBall.x;
        let dy = mouseY - currentBall.y;
        let angle = Math.atan2(dy, dx);
        
        // Kecepatan
        let speed = 15;
        
        bullet = {
            x: currentBall.x,
            y: currentBall.y,
            vx: Math.cos(angle) * speed,
            vy: Math.sin(angle) * speed,
            r: BUBBLE_RADIUS,
            problem: currentBall.problem,
            active: true
        };
        
        currentBall = null; // Kosongkan shooter
    }

    function update() {
        if (gameState !== 'PLAY') return;

        // Update Bullet
        if (bullet) {
            bullet.x += bullet.vx;
            bullet.y += bullet.vy;

            // Pantulan dinding kiri/kanan
            if (bullet.x - bullet.r < 0 || bullet.x + bullet.r > canvas.width) {
                bullet.vx *= -1;
            }

            // Mentok atas (salah tembak ke langit-langit -> tempel)
            if (bullet.y - bullet.r < 0) {
                snapToGrid();
            }

            // Cek tabrakan dengan bubble lain
            for (let b of bubbles) {
                if (!b.active) continue;
                let dx = bullet.x - b.x;
                let dy = bullet.y - b.y;
                let dist = Math.sqrt(dx*dx + dy*dy);

                if (dist < (bullet.r + b.r)) {
                    // Tabrakan terjadi!
                    handleCollision(b);
                    break;
                }
            }
        }

        // Update Particles
        particles.forEach((p, index) => {
            p.x += p.vx;
            p.y += p.vy;
            p.alpha -= 0.03;
            if(p.alpha <= 0) particles.splice(index, 1);
        });
    }

    function handleCollision(targetBubble) {
        // Cek Jawaban: Apakah angka di peluru == hasil soal di target?
        // Note: Peluru bawa 'problem' juga, tapi kita ambil nilai 'a' (answer) nya.
        // Target bawa 'problem', kita cek nilai 'a' nya.
        
        let userAnswer = bullet.problem.a;
        let targetAnswer = targetBubble.problem.a;

        if (userAnswer === targetAnswer) {
            // BENAR! Hancurkan bola
            createExplosion(targetBubble.x, targetBubble.y, targetBubble.problem.color);
            targetBubble.active = false;
            
            score += 10;
            correctCount++;
            
            // Cek Win Condition Stage
            if (correctCount >= 5) {
                stageClear();
            }
            
            bullet = null;
            reloadShooter();
        } else {
            // SALAH! Tempel bola
            snapToGrid();
        }
        updateHUD();
    }

    function snapToGrid() {
        // Bola peluru berhenti dan menjadi soal baru
        // "Jika salah maka bola akan menempel dan berubah dengan perkalian"
        // Peluru (misal angka 12) -> Berubah jadi soal (misal 3x4)
        
        // Cari posisi snap terdekat (grid logic sederhana)
        // Kita cukup set posisi saat ini menjadi Bubble baru
        
        // Ubah jadi Question agar terlihat sebagai soal di grid
        // Kita cari soal yang jawabannya sesuai dengan angka bola peluru
        // Tapi untuk simplifikasi, kita pakai data problem yang sudah ada di bola peluru,
        // cuma ubah flagnya jadi display question.
        
        let newB = new Bubble(bullet.x, bullet.y, bullet.problem);
        newB.isQuestion = true; 
        bubbles.push(newB);
        
        // Penalti: Tambah baris baru jika salah (opsional, tapi diminta di spec "bola menempel")
        // Di sini kita cuma tempel saja biar gak terlalu sadis buat anak SD.
        
        bullet = null;
        reloadShooter();
        
        // Cek Game Over (kalau bola nyentuh bawah)
        if (newB.y > canvas.height - 100) {
            gameOver();
        }
    }

    function stageClear() {
        if (stage < 3) {
            stage++;
            alert(`HEBAT! Lanjut ke Stage ${stage}`); // Bisa ganti modal cantik
            resetStage();
        } else {
            gameVictory();
        }
        updateHUD();
    }

    function createExplosion(x, y, color) {
        for(let i=0; i<10; i++) {
            particles.push({
                x: x, y: y,
                vx: (Math.random() - 0.5) * 5,
                vy: (Math.random() - 0.5) * 5,
                color: color,
                alpha: 1
            });
        }
    }

    function draw() {
        // Clear Canvas
        ctx.clearRect(0, 0, canvas.width, canvas.height);

        // Grid Bubbles
        bubbles.forEach(b => b.draw(ctx));

        // Shooter Line (Aiming guide)
        if (currentBall && gameState === 'PLAY') {
            ctx.beginPath();
            ctx.moveTo(currentBall.x, currentBall.y);
            
            // Limit line length
            let dx = mouseX - currentBall.x;
            let dy = mouseY - currentBall.y;
            let angle = Math.atan2(dy, dx);
            let guideLen = 100;
            
            ctx.lineTo(currentBall.x + Math.cos(angle)*guideLen, currentBall.y + Math.sin(angle)*guideLen);
            ctx.strokeStyle = 'rgba(255,255,255,0.5)';
            ctx.lineWidth = 4;
            ctx.setLineDash([10, 5]);
            ctx.stroke();
            ctx.setLineDash([]);
        }

        // Bullet
        if (bullet) {
            // Draw bullet manually here since it's a simple object, not class instance yet
            ctx.beginPath();
            ctx.arc(bullet.x, bullet.y, bullet.r, 0, Math.PI*2);
            ctx.fillStyle = bullet.problem.color;
            ctx.fill();
            ctx.strokeStyle = '#fff';
            ctx.stroke();
            
            ctx.fillStyle = '#fff';
            ctx.font = "bold 16px 'Varela Round'";
            ctx.textAlign = "center";
            ctx.textBaseline = "middle";
            ctx.fillText(bullet.problem.a, bullet.x, bullet.y);
        }

        // Current Ball (Shooter)
        if (currentBall) currentBall.draw(ctx);
        
        // Next Ball (Preview)
        if (nextBall) {
            // Draw slightly smaller
            let oldR = nextBall.r;
            nextBall.r = 20;
            nextBall.draw(ctx);
            nextBall.r = oldR; // Restore
            
            ctx.fillStyle = "#666";
            ctx.font = "12px sans-serif";
            ctx.fillText("Next", nextBall.x, nextBall.y + 30);
        }

        // Particles
        particles.forEach(p => {
            ctx.globalAlpha = p.alpha;
            ctx.beginPath();
            ctx.arc(p.x, p.y, 5, 0, Math.PI*2);
            ctx.fillStyle = p.color;
            ctx.fill();
            ctx.globalAlpha = 1.0;
        });
        
        // Sniper Base (Hiasan)
        ctx.fillStyle = "#888";
        ctx.fillRect(canvas.width/2 - 40, canvas.height - 10, 80, 10);
    }

    function loop() {
        if (gameState === 'PLAY' || gameState === 'MENU') { // Render menu bg too? No, separated by HTML overlay
            update();
            draw();
            requestAnimationFrame(loop);
        }
    }

    // --- INTERAKSI UI ---

    function startGame() {
        document.getElementById('menu-screen').classList.add('hidden');
        document.getElementById('end-screen').classList.add('hidden');
        document.getElementById('game-ui').classList.remove('hidden');
        gameState = 'PLAY';
        initGame();
    }

    function showSettings() {
        document.getElementById('settings-screen').classList.remove('hidden');
    }

    function closeSettings() {
        document.getElementById('settings-screen').classList.add('hidden');
    }

    function updateHUD() {
        document.getElementById('score-val').innerText = score;
        document.getElementById('stage-val').innerText = stage;
        document.getElementById('target-val').innerText = (5 - correctCount);
    }

    function gameOver() {
        gameState = 'OVER';
        document.getElementById('game-ui').classList.add('hidden');
        document.getElementById('end-screen').classList.remove('hidden');
        document.getElementById('end-title').innerText = "YAHH KALAH!";
        document.getElementById('end-title').style.color = "red";
        document.getElementById('final-score').innerText = score;
    }

    function gameVictory() {
        gameState = 'OVER';
        document.getElementById('game-ui').classList.add('hidden');
        document.getElementById('end-screen').classList.remove('hidden');
        document.getElementById('end-title').innerText = "MENANG!";
        document.getElementById('end-title').style.color = "#4ECDC4";
        document.getElementById('final-score').innerText = score;
    }

    function togglePause() {
        if (gameState === 'PLAY') {
            gameState = 'PAUSE';
            alert("PAUSED. Klik OK untuk lanjut.");
            gameState = 'PLAY';
            loop();
        }
    }

    // Utility: Darken color
    function shadeColor(color, percent) {
        var R = parseInt(color.substring(1,3),16);
        var G = parseInt(color.substring(3,5),16);
        var B = parseInt(color.substring(5,7),16);

        R = parseInt(R * (100 + percent) / 100);
        G = parseInt(G * (100 + percent) / 100);
        B = parseInt(B * (100 + percent) / 100);

        R = (R<255)?R:255;  
        G = (G<255)?G:255;  
        B = (B<255)?B:255;  

        var RR = ((R.toString(16).length==1)?"0"+R.toString(16):R.toString(16));
        var GG = ((G.toString(16).length==1)?"0"+G.toString(16):G.toString(16));
        var BB = ((B.toString(16).length==1)?"0"+B.toString(16):B.toString(16));

        return "#"+RR+GG+BB;
    }

    // Event Listeners
    canvas.addEventListener('mousemove', e => {
        let rect = canvas.getBoundingClientRect();
        mouseX = e.clientX - rect.left;
        mouseY = e.clientY - rect.top;
    });

    canvas.addEventListener('mousedown', e => {
        if (gameState === 'PLAY') shoot();
    });

</script>
</body>

</html>
